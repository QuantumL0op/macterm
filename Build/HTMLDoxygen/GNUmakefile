# GNU makefile for building code documentation.
#
# Kevin Grant (kevin@ieee.org)
# March 26, 2005

PATH := /opt/doxygen/bin:/Applications/Doxygen.app/Contents/Resources:/Applications/GraphViz.app/Contents/MacOS:$(PATH)
OUTPUT_DIR := $(CURDIR)/documentation/

# determine MacTelnet version
# IMPORTANT: read from a built MacTelnet.app's Info.plist;
# if you don't build MacTelnet first, this won't work
VERSION_INFO := $(shell cd $(CURDIR)/../ ; ./VersionInfo.sh ; cd $(CURDIR))
MAJOR := $(word 1,$(VERSION_INFO))
MINOR := $(word 2,$(VERSION_INFO))
SUBMINOR := $(word 3,$(VERSION_INFO))
PRERELEASE := $(word 4,$(VERSION_INFO))
BUILD := $(word 5,$(VERSION_INFO))

# choose whichever designation is appropriate for this build
ABR := alpha
#ABR := beta
#ABR := release candidate

DOXYGEN := doxygen
DOXYGEN_CONF_TEMPLATE := $(CURDIR)/Resources/Doxygen.conf.in
TMP_CONF := /tmp/Doxygen.conf

APP_INCL := $(CURDIR)/../Application/Code/
APP_SRC := $(CURDIR)/../Application/Code/
DOC_SRC := $(CURDIR)/Resources/
IMG_SRC := $(CURDIR)/../Shared/Resources/
SHARED_INCL := $(CURDIR)/../Shared/Code/
SHARED_SRC := $(CURDIR)/../Shared/Code/
STYLE_SRC := $(CURDIR)/Resources/

.PHONY: all
all:
	$(begin_target)
	mkdir -p "$(strip $(OUTPUT_DIR))"
	$(MAKE) build
	$(end_target)

.PHONY: build
build:
	$(begin_target)
	$(custom_config)
	@# generate HTML from source
	$(DOXYGEN) "$(strip $(TMP_CONF))"
	@# throw away configuration file (no longer needed)
	$(RM) "$(strip $(TMP_CONF))"
	$(xcustom_index)
	@# note that postprocess depends on $(wildcard), which is resolved at
	@# the time the makefile is parsed; a recursive "make" ensures the
	@# wildcard is parsed only after Doxygen has actually created files!
	$(MAKE) postprocess
	$(copy_resources)
	$(MAKE) view
	$(end_target)

.PHONY: view
view:
	$(call open_browser_to_page,$(strip $(OUTPUT_DIR))/index.html)

.PHONY: postprocess
postprocess:
	$(foreach FILE,$(wildcard $(OUTPUT_DIR)/*.html),$(call strip_unwanted_sections,$(FILE)))

.PHONY: index
index:
	$(custom_index)

.PHONY: clean
clean:
	$(begin_target)
	$(RM) "$(OUTPUT_DIR)"/*
	-rmdir "$(OUTPUT_DIR)"
	$(end_target)

test:
	$(foreach FILE,$(wildcard $(OUTPUT_DIR)/*.html),$(call strip_unwanted_sections,$(FILE)))

define begin_target
	@date "+      $(notdir $@): Started at %T."
endef

define end_target
	@date "+Finished $(notdir $@)."
endef

define copy_resources
	@# copy in style sheets
	@echo "Copying style sheets..."
	cp "$(strip $(STYLE_SRC))/code.css" "$(strip $(OUTPUT_DIR))/"
	cp "$(strip $(STYLE_SRC))/tabs.css" "$(strip $(OUTPUT_DIR))/"
	cp "$(strip $(STYLE_SRC))/default.css" "$(strip $(OUTPUT_DIR))/"
	@# style sheets refer to a few images that should be present
	@echo "Copying images..."
	cp "$(strip $(IMG_SRC))/LogoBlurFull.jpg" "$(strip $(OUTPUT_DIR))/"
	cp "$(strip $(IMG_SRC))/SubtleBorderTop.png" "$(strip $(OUTPUT_DIR))/"
	cp "$(strip $(IMG_SRC))/TabLeft.png" "$(strip $(OUTPUT_DIR))/"
	cp "$(strip $(IMG_SRC))/TabRight.png" "$(strip $(OUTPUT_DIR))/"
	cp "$(strip $(IMG_SRC))/TabBottom.png" "$(strip $(OUTPUT_DIR))/"
	cp "$(strip $(IMG_SRC))/Translucent64x64.png" "$(strip $(OUTPUT_DIR))/"
	cp "$(strip $(IMG_SRC))/White40Translucent64x64.png" "$(strip $(OUTPUT_DIR))/"
	cp "$(strip $(IMG_SRC))/White60Translucent64x64.png" "$(strip $(OUTPUT_DIR))/"

endef

define custom_config
	@# create the Doxygen configuration file that will actually be used
	@echo "Creating custom Doxygen configuration file by substituting template variables..."
	$(RM) "$(strip $(TMP_CONF))"
	cp "$(strip $(DOXYGEN_CONF_TEMPLATE))" "$(strip $(TMP_CONF))"
	@# replace template variables with actual values
	perl -pi -e "s|===APP_SOURCE===|$(strip $(APP_SRC))|" "$(strip $(TMP_CONF))"
	perl -pi -e "s|===APP_INCL===|$(strip $(APP_INCL))|" "$(strip $(TMP_CONF))"
	perl -pi -e "s|===HTML_SOURCE===|$(strip $(DOC_SRC))|" "$(strip $(TMP_CONF))"
	perl -pi -e "s|===OUTPUT_DIR===|$(strip $(OUTPUT_DIR))|" "$(strip $(TMP_CONF))"
	perl -pi -e "s|===SHARED_SOURCE===|$(strip $(SHARED_SRC))|" "$(strip $(TMP_CONF))"
	perl -pi -e "s|===SHARED_INCL===|$(strip $(SHARED_INCL))|" "$(strip $(TMP_CONF))"
	perl -pi -e "s|===VERSION===|$(MAJOR).$(MINOR).$(SUBMINOR) ($(ABR) $(PRERELEASE)) build $(BUILD)|" \
			"$(strip $(TMP_CONF))"

endef

define custom_index
	@# replace Doxygen-generated index page with something a bit nicer
	@echo "Creating custom index file by substituting template variables..."
	cp "$(strip $(DOC_SRC))/index.html.in" "$(strip $(OUTPUT_DIR))/index.html"
	perl -pi -e "s|===VERSION===|$(MAJOR).$(MINOR).$(SUBMINOR) ($(ABR) $(PRERELEASE)) build $(BUILD)|" \
			"$(strip $(OUTPUT_DIR))/index.html"

endef

define open_browser_to_page
	echo 'open location "file://$(strip $(1))"' | osascript
endef

define strip_unwanted_sections
	@# based on what Doxygen 1.4.7 generates
	@echo "Stripping unwanted parts from Doxygen-generated files..."
	@# The command below "bumps down" heading tags generated by Doxygen; where Doxygen says
	@# "<h1>" it becomes "<h3>", etc. since "Resources/header.html.in" chooses to create
	@# base "<h1>" and "<h2>" headings of its own.  A "<!-- template -->" suffix comment is
	@# placed after all header tags from "header.html.in", so that they can be avoided here.
	perl -pi -e "\
			s|<h4>([^<]+)</h4>(?!<\!\-\- template)|<h6>\1</h6>|g; \
			s|<h3>([^<]+)</h3>(?!<\!\-\- template)|<h5>\1</h5>|g; \
			s|<h2>([^<]+)</h2>(?!<\!\-\- template)|<h4>\1</h4>|g; \
			s|<h1>([^<]+)</h1>(?!<\!\-\- template)|<h3>\1</h3>|g; \
			s|(\"memname\">[^\:]+\:\:)|\1<br>|g; \
			s|(\"memname\"><a.*?</a>)|\1<br>|g; \
			s|(\"memname\">\s*[^<]\S+)(\s+)|\1<br>\2|g; \
			s|<td>\(</td>|<td valign=\"bottom\">(</td>|g; \
			s|(<td class=\"paramtype\")|\1 valign=\"bottom\"|g; \
			s|(<td class=\"paramname\")|\1 valign=\"bottom\"|g; \
			s|<td>(\&nbsp\;)*?\)(\&nbsp\;)*?</td>|<td valign=\"bottom\">)</td>|g; \
			"\
			"$(1)"

endef

